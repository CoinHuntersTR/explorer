<script lang="ts" setup>
import {
    useBaseStore,
    useBlockchain,
    useFormatter,
    useMintStore,
    useStakingStore,
    useTxDialog,
} from '@/stores';
import { computed, ref } from 'vue';
import { onMounted } from 'vue';
import { Icon } from '@iconify/vue';
import type { Key, SlashingParam, Validator } from '@/types';
import { formatSeconds}  from '@/libs/utils'
import { diff } from 'semver';

const staking = useStakingStore();
const base = useBaseStore();
const format = useFormatter();
const dialog = useTxDialog();
const chainStore = useBlockchain();
const mintStore = useMintStore()

const cache = JSON.parse(localStorage.getItem('avatars') || '{}');
const avatars = ref(cache || {});
const latest = ref({} as Record<string, number>);
const yesterday = ref({} as Record<string, number>);
const tab = ref('active');
const unbondList = ref([] as Validator[]);
const slashing = ref({} as SlashingParam)
const searchQuery = ref('');

onMounted(() => {
    staking.fetchUnbondingValdiators().then((res) => {
        unbondList.value = res.concat(unbondList.value);
    });
    staking.fetchInacitveValdiators().then((res) => {
        unbondList.value = unbondList.value.concat(res);
    });
    chainStore.rpc.getSlashingParams().then(res => {
        slashing.value = res.params
    })
});

async function fetchChange(blockWindow: number = 14400) {
    let page = 0;

    let height = Number(base.latest?.block?.header?.height || 0);
    if (height > blockWindow) {
        height -= blockWindow;
    } else {
        height = 1;
    }
    // voting power in 24h ago
    while (page < staking.validators.length && height > 0) {
        await base.fetchValidatorByHeight(height, page).then((x) => {
            x.validators.forEach((v) => {
                yesterday.value[v.pub_key.key] = Number(v.voting_power);
            });
        });
        page += 100;
    }

    page = 0;
    // voting power for now
    while (page < staking.validators.length) {
        await base.fetchLatestValidators(page).then((x) => {
            x.validators.forEach((v) => {
                latest.value[v.pub_key.key] = Number(v.voting_power);
            });
        });
        page += 100;
    }
}

const changes = computed(() => {
    const changes = {} as Record<string, number>;
    Object.keys(latest.value).forEach((k) => {
        const l = latest.value[k] || 0;
        const y = yesterday.value[k] || 0;
        changes[k] = l - y;
    });
    return changes;
});

const change24 = (entry: { consensus_pubkey: Key; tokens: string }) => {
    const txt = entry.consensus_pubkey.key;
    const latestValue = latest.value[txt];
    if (!latestValue) {
        return 0;
    }

    const displayTokens = format.tokenAmountNumber({
        amount: parseInt(entry.tokens, 10).toString(),
        denom: staking.params.bond_denom,
    });
    const coefficient = displayTokens / latestValue;
    return changes.value[txt] * coefficient;
};

const change24Text = (entry: { consensus_pubkey: Key; tokens: string }) => {
    if (!entry) return '';
    const v = change24(entry);
    return v && v !== 0 ? format.showChanges(v) : '';
};

const change24Color = (entry: { consensus_pubkey: Key; tokens: string }) => {
    if (!entry) return '';
    const v = change24(entry);
    if (v > 0) return 'text-success';
    if (v < 0) return 'text-error';
};

const calculateRank = function (position: number) {
    let sum = 0;
    for (let i = 0; i < position; i++) {
        sum += Number(staking.validators[i]?.delegator_shares);
    }
    const percent = sum / staking.totalPower;

    switch (true) {
        case tab.value === 'active' && percent < 0.33:
            return 'error';
        case tab.value === 'active' && percent < 0.67:
            return 'warning';
        default:
            return 'primary';
    }
};

function isFeatured(endpoints: string[], who?: {website?: string, moniker: string }) {
    if(!endpoints || !who) return false
    return endpoints.findIndex(x => who.website && who.website?.substring(0, who.website?.lastIndexOf('.')).endsWith(x) || who?.moniker?.toLowerCase().search(x.toLowerCase()) > -1) > -1
}

const list = computed(() => {
    if (tab.value === 'active') {
        return staking.validators.map((x, i) => ({v: x, rank: calculateRank(i), logo: logo(x.description.identity)}));
    } else if (tab.value === 'featured') {
        const endpoint = chainStore.current?.endpoints?.rest?.map(x => x.provider)
        if(endpoint) {
            endpoint.push('ping')
            return staking.validators
                .filter(x => isFeatured(endpoint, x.description))
                .map((x, i) => ({v: x, rank: 'primary', logo: logo(x.description.identity)}));
        }
        return []        
    }
    return unbondList.value.map((x, i) => ({v: x, rank: 'primary', logo: logo(x.description.identity)}));
});

const filteredList = computed(() => {
    const lowerQuery = searchQuery.value.toLowerCase();
    return list.value.filter(item => {
        return item.v.description?.moniker?.toLowerCase().includes(lowerQuery) || 
               item.v.description?.website?.toLowerCase().includes(lowerQuery) ||
               item.v.description?.identity?.toLowerCase().includes(lowerQuery);
    });
});

const fetchAvatar = (identity: string) => {
  return new Promise<void>((resolve) => {
    staking
      .keybase(identity)
      .then((d) => {
        if (Array.isArray(d.them) && d.them.length > 0) {
          const uri = String(d.them[0]?.pictures?.primary?.url).replace(
            'https://s3.amazonaws.com/keybase_processed_uploads/',
            ''
          );

          avatars.value[identity] = uri;
          resolve();
        } else throw new Error(`failed to fetch avatar for ${identity}`);
      })
      .catch((error) => {
        resolve();
      });
  });
};

const loadAvatar = (identity: string) => {
  fetchAvatar(identity).then(() => {
    localStorage.setItem('avatars', JSON.stringify(avatars.value));
  });
};

const loadAvatars = () => {
  const promises = staking.validators.map((validator) => {
    const identity = validator.description?.identity;
    if (identity && !avatars.value[identity]) {
      return fetchAvatar(identity);
    } else {
      return Promise.resolve();
    }
  });

  Promise.all(promises).then(() =>
    localStorage.setItem('avatars', JSON.stringify(avatars.value))
  );
};

const logo = (identity?: string) => {
    if (!identity || !avatars.value[identity]) return '';
    const url = avatars.value[identity] || '';
    return url.startsWith('http')
        ? url
        : `https://s3.amazonaws.com/keybase_processed_uploads/${url}`;
};

const loaded = ref(false);
base.$subscribe((_, s) => {
    if (s.recents.length >= 2 && loaded.value === false) {
        loaded.value = true;
        const diff_time = Date.parse(s.recents[1].block.header.time) - Date.parse(s.recents[0].block.header.time)
        const diff_height = Number(s.recents[1].block.header.height) - Number(s.recents[0].block.header.height)
        const block_window = Number(Number(86400 * 1000 * diff_height / diff_time).toFixed(0))
        fetchChange(block_window);
    }
});

loadAvatars();
</script>
<template>
<div>
    <div class="bg-base-100 rounded-lg grid sm:grid-cols-1 md:grid-cols-4 p-4" >    
        <div class="flex">
            <span>
                <div class="relative w-9 h-9 rounded overflow-hidden flex items-center justify-center mr-2">
                    <Icon class="text-success" icon="mdi:trending-up" size="32" />
                    <div class="absolute top-0 left-0 bottom-0 right-0 opacity-20 bg-success"></div>
                </div>
            </span>
            <span>
                <div class="font-bold">{{ format.percent(mintStore.inflation) }}</div>
                <div class="text-xs">{{ $t('staking.inflation') }}</div>
            </span>
        </div>
        <div class="flex">
            <span>
                <div class="relative w-9 h-9 rounded overflow-hidden flex items-center justify-center mr-2">
                    <Icon class="text-primary" icon="mdi:lock-open-outline" size="32" />
                    <div class="absolute top-0 left-0 bottom-0 right-0 opacity-20 bg-primary"></div>
                </div>
            </span>
            <span>
                <div class="font-bold">{{ formatSeconds(staking.params?.unbonding_time) }}</div>
                <div class="text-xs">{{ $t('staking.unbonding_time') }}</div>
            </span>
        </div> 
        <div class="flex">
            <span>
                <div class="relative w-9 h-9 rounded overflow-hidden flex items-center justify-center mr-2">
                    <Icon class="text-error" icon="mdi:alert-octagon-outline" size="32" />
                    <div class="absolute top-0 left-0 bottom-0 right-0 opacity-20 bg-error"></div>
                </div>
            </span>
            <span>
            <div class="font-bold">{{ format.percent(slashing.slash_fraction_double_sign) }}</div>
            <div class="text-xs">{{ $t('staking.double_sign_slashing') }}</div>
            </span>
        </div> 
        <div class="flex">
            <span>
                <div class="relative w-9 h-9 rounded overflow-hidden flex items-center justify-center mr-2">
                    <Icon class="text-error" icon="mdi:pause" size="32" />
                    <div class="absolute top-0 left-0 bottom-0 right-0 opacity-20 bg-error"></div>
                </div>
            </span>
            <span>
            <div class="font-bold">{{ format.percent(slashing.slash_fraction_downtime) }}</div>
            <div class="text-xs">{{ $t('staking.downtime_slashing') }}</div>
            </span>
        </div>  
    </div>

    <div>
        <div class="flex items-center justify-between py-1">
            <div class="tabs tabs-boxed bg-transparent">
                <a
                    class="tab text-gray-400"
                    :class="{ 'tab-active': tab === 'featured' }"
                    @click="tab = 'featured'"
                    >{{ $t('staking.popular') }}</a
                >
                <a
                    class="tab text-gray-400"
                    :class="{ 'tab-active': tab === 'active' }"
                    @click="tab = 'active'"
                    >{{ $t('staking.active') }}</a
                >
                <a
                    class="tab text-gray-400"
                    :class="{ 'tab-active': tab === 'inactive' }"
                    @click="tab = 'inactive'"
                    >{{ $t('staking.inactive') }}</a
                >
            </div>

            <div class="flex items-center gap-4">
                <div class="form-control">
                    <input type="text" 
                           placeholder="Search validator..." 
                           class="input input-bordered w-full max-w-xs" 
                           v-model="searchQuery"/>
                </div>
                <div class="text-lg font-semibold">
                    {{ filteredList.length }}/{{ staking.params.max_validators }}
                </div>
            </div>
        </div>

        <div class="bg-base-100 p-4 rounded shadow">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="({v, rank, logo}, i) in filteredList" 
                     :key="v.operator_address"
                     class="card bg-base-100 shadow-lg hover:shadow-xl transition-all duration-200 border border-gray-100 dark:border-gray-800">
                    <div class="card-body p-4">
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm font-semibold px-3 py-1 rounded-full"
                                 :class="`text-${rank} bg-${rank} bg-opacity-10`">
                                #{{ i + 1 }}
                            </div>
                            <div class="flex-1 flex items-center gap-3">
                                <div class="avatar">
                                    <div class="w-10 h-10 rounded-full">
                                        <img v-if="logo" 
                                             :src="logo" 
                                             class="object-contain"
                                             @error="(e) => { const identity = v.description?.identity; if (identity) loadAvatar(identity); }"
                                        />
                                        <Icon v-else class="text-3xl" icon="mdi-help-circle-outline" />
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <RouterLink :to="{ name: 'chain-staking-validator', params: { validator: v.operator_address }}"
                                              class="text-primary dark:text-primary-light font-medium block truncate">
                                        {{ v.description?.moniker }}
                                    </RouterLink>
                                    <div class="text-xs text-gray-500 truncate">
                                        {{ v.description?.website || v.description?.identity || '-' }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-base-200 rounded-lg p-3">
                                <div class="text-xs text-gray-500 mb-1">{{ $t('staking.voting_power') }}</div>
                                <div class="font-medium">
                                    {{ format.formatToken({ amount: parseInt(v.tokens).toString(), denom: staking.params.bond_denom }, true, '0,0') }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    {{ format.calculatePercent(v.delegator_shares, staking.totalPower) }}
                                </div>
                            </div>
                            <div class="bg-base-200 rounded-lg p-3">
                                <div class="text-xs text-gray-500 mb-1">{{ $t('staking.commission') }}</div>
                                <div class="font-medium">
                                    {{ format.formatCommissionRate(v.commission?.commission_rates?.rate) }}
                                </div>
                                <div class="text-xs" :class="change24Color(v)">
                                    {{ change24Text(v) }}
                                </div>
                            </div>
                        </div>

                        <div class="card-actions justify-end">
                            <div v-if="v.jailed" class="badge badge-error gap-2 text-white">
                                {{ $t('staking.jailed') }}
                            </div>
                            <label v-else
                                   for="delegate"
                                   class="btn btn-sm btn-primary"
                                   @click="dialog.open('delegate', { validator_address: v.operator_address })">
                                {{ $t('account.btn_delegate') }}
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>
            <div class="flex flex-row items-center">
                <div
                    class="text-xs truncate relative py-2 px-4 rounded-md w-fit text-error mr-2"
                >
                    <span
                        class="inset-x-0 inset-y-0 opacity-10 absolute bg-error"
                    ></span>
                    {{ $t('staking.top') }} 33%
                </div>
                <div
                    class="text-xs truncate relative py-2 px-4 rounded-md w-fit text-warning"
                >
                    <span
                        class="inset-x-0 inset-y-0 opacity-10 absolute bg-warning"
                    ></span>
                    {{ $t('staking.top') }} 67%
                </div>
                <div class="text-xs hidden md:!block pl-2">
                    {{ $t('staking.description') }}
                </div>
            </div>
        </div>
    </div>
</div>
</template>

<route>
  {
    meta: {
      i18n: 'staking',
      order: 3
    }
  }
</route>

<style>
.staking-table.table :where(th, td) {
    padding: 8px 5px;
    background: transparent;
}
</style>